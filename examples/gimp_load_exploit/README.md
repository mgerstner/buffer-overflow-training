Buffer overflow in Gimp's `ani_load_image()`
============================================

Files with `.ani` extension are Microsoft Windows animated cursor files. Gimp
has support to load them via a dedicated file format handler plugin. This handler
contains a classical stack buffer overflow vulnerability. It was handled in
SUSE bugzilla as [bsc#1243710][1] and was assigned CVE-2025-48796. The
upstream Git repository is hosted on Gnome's [GitLab][2]. The issue was fixed
in Gimp version 2.99.16. For inspecting the vulnerability we need to `git
checkout GIMP_2_99_14`.

[1]: https://bugzilla.suse.com/show_bug.cgi?id=1243710 
[2]: https://gitlab.gnome.org/GNOME/gimp

The Vulnerability
-----------------

The problem is found in `ico-load.c` lines 826 and 840. The `inam` and `iart`
arrays are sized `G_MAXSHORT` which is 32 KiB. A `size` field is parsed from
the image in this line:

    fread (&size, sizeof (size), 1, fp);

`size` is an unsigned 32-bit data type and can thus declare up to 4 GiB of
data following in the image. `size` bytes found in the input file are now
copied over in this line:

    fread (&inam, sizeof (char), size, fp);

This means we can place arbitrary data contained in the image on the stack,
easily overwriting the saved `rip`. Since there are at least 32 KiB of buffer
space before reaching the `rip` there is also enough space to store exploit
code and a NOP slide.

This is a classic stack overflow vulnerability and easy to exploit. In the
upstream [merge request to fix this][3], a [working exploit][4] is already
provided.

[3]: https://gitlab.gnome.org/GNOME/gimp/-/merge_requests/879
[4]: https://gitlab.gnome.org/GNOME/gimp/uploads/06367e9281583408e4b34f351b191884/examplefile.ani

Since this exploit is so straightforward and an exploit already publicly
available, I did not dive deeper into this. You can try to reproduce the
exploit as an exercise. You can also check out the public exploit to see how
it is structured.

Attack Scenario
---------------

The most likely attack scenario here is that an untrusted `*.ani` file is
downloaded from the Internet and opened in Gimp, triggering the overflow.

Lessons Learnt
--------------

This is a typical vulnerability found in media file parsers implemented in C.
Such code needs good helper routines for memory management and parsing,
furthermore peer review would be prudent to avoid such issues. Ideally such
parsers are simply implemented in more expressive programming languages these
days.
